<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atualização CSV - Pernambuco III</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
      color: #fff;
    }
    header {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #0af;
      position: sticky;
      top: 0;
      z-index: 999;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    header img {
      height: 80px;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(45deg, #0af, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-left: 1rem;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .btn-voltar {
      background: linear-gradient(45deg, #0af, #00d4ff);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 170, 255, 0.3);
    }
    .btn-voltar:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4);
    }
    .btn-sair {
      background: linear-gradient(45deg, #dc3545, #ff4757);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    .btn-sair:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }
    .container {
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }
    .form-card {
      background: linear-gradient(135deg, #2c2c2c 0%, #3c3c3c 100%);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      background: linear-gradient(45deg, #0af, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .instrucoes {
      background: rgba(68, 68, 68, 0.5);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      border-left: 4px solid #0af;
      line-height: 1.6;
    }
    .instrucoes h3 {
      margin-top: 0;
      color: #0af;
    }
    .exemplo {
      background: rgba(85, 85, 85, 0.8);
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      margin: 1rem 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem 0;
      font-weight: bold;
      background: linear-gradient(45deg, #0af, #00d4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    textarea {
      width: 100%;
      height: 300px;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(68, 68, 68, 0.8);
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    textarea:focus {
      outline: none;
      border-color: #0af;
      background-color: rgba(85, 85, 85, 0.9);
      box-shadow: 0 0 15px rgba(0, 170, 255, 0.3);
    }
    .botao-atualizar {
      background: linear-gradient(45deg, #0af, #00d4ff);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 1rem;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 170, 255, 0.3);
    }
    .botao-atualizar:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4);
    }
    .botao-atualizar:disabled {
      background: linear-gradient(45deg, #666, #777);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .mensagem {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
    .sucesso {
      background: linear-gradient(45deg, #2e7d32, #4caf50);
      color: white;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
    }
    .erro {
      background: linear-gradient(45deg, #c62828, #ff4757);
      color: white;
      box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3);
    }
    .aviso {
      background: linear-gradient(45deg, #fbc02d, #ffdd59);
      color: black;
      box-shadow: 0 4px 15px rgba(251, 192, 45, 0.3);
    }
    .progresso {
      background: rgba(68, 68, 68, 0.5);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      display: none;
    }
    .progresso-barra {
      width: 100%;
      height: 20px;
      background: rgba(85, 85, 85, 0.8);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progresso-preenchimento {
      height: 100%;
      background: linear-gradient(45deg, #0af, #00d4ff);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      .form-card {
        padding: 1.5rem;
      }
      header img {
        height: 60px;
      }
      .header-title {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="logomarca.png" alt="Logo Pernambuco III">
      <div class="header-title">QUADRO DE DISPONIBILIDADE</div>
    </div>
    <div class="header-right">
      <button class="btn-voltar" onclick="voltarParaEntrada()">Voltar para Entrada</button>
      <button class="btn-sair" onclick="sair()">Sair</button>
    </div>
  </header>
  
  <div class="container">
    <div class="form-card">
      <h1>Atualização de Status via CSV</h1>
      
      <div class="instrucoes">
        <h3>Instruções:</h3>
        <p>Cole o conteúdo do CSV abaixo para atualizar múltiplos equipamentos de uma vez. O formato esperado é:</p>
        <p><strong>TAG,STATUS,MOTIVO,PTS,OS,RETORNO,CADEADO,OBSERVACOES</strong></p>
        
        <h4>Valores aceitos para STATUS:</h4>
        <ul>
          <li><strong>OPE</strong> - Em Operação</li>
          <li><strong>ST-BY</strong> - Em Stand-by</li>
          <li><strong>MANU</strong> - Em Manutenção</li>
        </ul>
        
        <h4>Exemplo:</h4>
        <div class="exemplo">TR01 - 04T1,MANU,,PTS-001,OS-001,2025-12-31T10:00,CADEADO-001,Manutenção preventiva
UG#01,OPE,,,,,
BAU901,ST-BY,Conveniencia operacional,,,,</div>
        
        <p><strong>Observações:</strong></p>
        <ul>
          <li>Campos vazios podem ser deixados em branco, mas as vírgulas devem ser mantidas</li>
          <li>Data de retorno deve estar no formato: AAAA-MM-DDTHH:MM</li>
          <li>Apenas equipamentos existentes serão atualizados</li>
        </ul>
      </div>

      <label for="csv-dados">Dados CSV:</label>
      <textarea id="csv-dados" placeholder="Cole os dados CSV aqui..."></textarea>

      <button class="botao-atualizar" id="btn-atualizar" onclick="processarCSV()">Atualizar Status</button>
      
      <div class="progresso" id="progresso-container">
        <div>Processando atualizações...</div>
        <div class="progresso-barra">
          <div class="progresso-preenchimento" id="progresso-barra"></div>
        </div>
        <div id="progresso-texto">0%</div>
      </div>
      
      <div id="mensagem" style="display:none;"></div>
    </div>
  </div>

  <script>
    // Lista de equipamentos válidos
    const equipamentosValidos = [
    "TR01 - 04T1", "TR02 - 04T2", "DJ - 14T1", "DJ - 14T2", "DJ - 14P2-1", "DJ - 14P2", "DJ - 52C", "LT04-P2",
    "UG#01", "UG#02", "UG#03", "UG#04", "UG#05", "UG#06", "UG#07", "UG#08", "UG#09", "UG#10", "UG#11", "UG#12",
    "UG#13", "UG#14", "UG#15", "UG#16", "UG#17", "UG#18", "UG#19", "UG#20", "UG#21", "UG#22", "UG#23",
    "BAU901", "BAU902", "BAU903", "BAU904", "BAA901", "BAA902", "BAA903", "BAA904", "BAO901", "BAO902", "BAO903", "BAO904",
    "BAE011", "BAE021", "BAE031", "BAE041", "BAE051", "BAE061", "BAE071", "BAE081", "BAE091", "BAE101", "BAE111", "BAE121",
    "BAE131", "BAE141", "BAE151", "BAE161", "BAE171", "BAE181", "BAE191", "BAE201", "BAE211", "BAE221", "BAE231",
    "QBB011", "QBB021", "QBB031", "QBB041", "QBB051", "QBB061", "QBB071", "QBB081", "QBB091", "QBB101", "QBB111", "QBB121",
    "QBB131", "QBB141", "QBB151", "QBB161", "QBB171", "QBB181", "QBB191", "QBB201", "QBB211", "QBB221", "QBB231",
    "PBB901.1", "PBB901.2", "PBB901.3", "PBB902.1", "PBB902.2", "PBB902.3", "SAB901", "TCA901", "TCA902", "TCA903",
    "TSA901.1", "TSA901.2", "TSA902.1", "TSA902.2", "PAA901.1", "PAA901.2", "PAA902.1", "PAA902.2", "PAA903.1", "PAA903.2",
    "PAA904.1", "PAA904.2", "PAC901.1", "PAC901.2", "PAC902", "PCA901.1", "PCA901.2", "PCA902", "PCA903.1", "PCA903.2",
    "RCE901", "RCE902", "RCC061", "RCC121", "RCC181", "RCC191", "RCC201", "RBB901.1", "RBB901.2", "RDD901.1", "RDD901.2",
    "BFB901", "BFB902", "BFB903", "BFB904", "QAA901", "QAE901.1", "QAE901.2", "QAB901", "DAD901", "DAD902", "DAD903",
    "DAD904", "DAD905", "DAD906", "DAD908", "DAD909", "DAD910", "DAD911", "VFC-Jockey", "VFC-elétrica", "VFC-Diesel",
    "Abrand/osmose", "VDB901.1", "VDB901.2", "VDB902.1", "VDB902.2", "QBF011", "QBF021", "QBF031", "QBF041", "QBF051",
    "QBF061", "QBF071", "QBF081", "QBF091", "QBF101", "QBF111", "QBF121", "QBF131", "QBF141", "QBF151", "QBF161",
    "QBF171", "QBF181", "QBF191", "QBF201", "QBF211", "QBF221", "QBF231", "VCA011 - VCA012", "VCA021 - VCA022",
    "VCA031 - VCA032", "VCA041 - VCA042", "VCA051 - VCA052", "VCA061 - VCA062", "VCA071 - VCA072", "VCA081 - VCA082",
    "VCA091 - VCA092", "VCA101 - VCA102", "VCA111 - VCA112", "VCA121 - VCA122", "VCA131 - VCA132", "VCA141 - VCA142",
    "VCA151 - VCA152", "VCA161 - VCA162", "VCA171 - VCA172", "VCA181 - VCA182", "VCA191 - VCA192", "VCA201 - VCA202",
    "VCA211 - VCA212", "VCA221 - VCA222", "VCA231 - VCA232"
];

    function mostrarMensagem(texto, tipo) {
      const mensagemDiv = document.getElementById('mensagem');
      mensagemDiv.textContent = texto;
      mensagemDiv.className = `mensagem ${tipo}`;
      mensagemDiv.style.display = 'block';
      setTimeout(() => {
        mensagemDiv.style.display = 'none';
      }, 5000);
    }

    function mostrarProgresso(porcentagem, texto) {
      const container = document.getElementById('progresso-container');
      const barra = document.getElementById('progresso-barra');
      const textoProgresso = document.getElementById('progresso-texto');
      
      container.style.display = 'block';
      barra.style.width = porcentagem + '%';
      textoProgresso.textContent = texto;
    }

    function esconderProgresso() {
      document.getElementById('progresso-container').style.display = 'none';
    }

    function salvarRegistro(equipamento, statusAnterior, novoStatus, dados) {
      const registros = JSON.parse(localStorage.getItem('registros-modificacoes') || '[]') || [];
      
      const registro = {
        id: Date.now() + Math.random(), // Garantir unicidade
        timestamp: new Date().toISOString(),
        equipamento: equipamento,
        statusAnterior: statusAnterior || 'Não definido',
        novoStatus: novoStatus,
        usuario: 'admin', // CSV sempre é admin
        dados: dados
      };
      
      registros.unshift(registro);
      
      // Manter apenas os últimos 50 registros
      if (registros.length > 50) {
        registros.splice(50);
      }
      
      localStorage.setItem('registros-modificacoes', JSON.stringify(registros));
    }

    async function processarCSV() {
      const csvDados = document.getElementById('csv-dados').value.trim();
      const btnAtualizar = document.getElementById('btn-atualizar');
      
      if (!csvDados) {
        mostrarMensagem('Por favor, cole os dados CSV antes de continuar.', 'erro');
        return;
      }

      btnAtualizar.disabled = true;
      btnAtualizar.textContent = 'Processando...';
      
      try {
        const linhas = csvDados.split('\n').filter(linha => linha.trim());
        let processados = 0;
        let sucessos = 0;
        let erros = [];

        mostrarProgresso(0, '0%');

        for (let i = 0; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;

          const campos = linha.split(',').map(campo => campo.trim());
          
          if (campos.length < 8) {
            erros.push(`Linha ${i + 1}: Formato inválido (${campos.length} campos, esperado 8)`);
            continue;
          }

          const [tag, status, motivo, pts, os, retorno, cadeado, observacoes] = campos;

          // Validar TAG
          if (!equipamentosValidos.includes(tag)) {
            erros.push(`Linha ${i + 1}: Equipamento "${tag}" não encontrado`);
            continue;
          }

          // Validar STATUS
          if (!['OPE', 'ST-BY', 'MANU'].includes(status)) {
            erros.push(`Linha ${i + 1}: Status "${status}" inválido (use OPE, ST-BY ou MANU)`);
            continue;
          }

          // Obter status anterior
          const statusAnterior = localStorage.getItem(`status-${tag}`);
          const dadosAnteriores = statusAnterior ? JSON.parse(statusAnterior) : {};

          // Preparar dados
          const dados = {
            status: status,
            motivo: motivo || '',
            pts: pts || '',
            os: os || '',
            retorno: retorno || '',
            cadeado: cadeado || '',
            observacoes: observacoes || ''
          };

          // Salvar no localStorage
          localStorage.setItem(`status-${tag}`, JSON.stringify(dados));
          
          // Registrar modificação
          salvarRegistro(tag, dadosAnteriores.status, status, dados);
          
          sucessos++;
          processados++;
          
          // Atualizar progresso
          const porcentagem = Math.round((processados / linhas.length) * 100);
          mostrarProgresso(porcentagem, `${porcentagem}% - ${processados}/${linhas.length} processados`);
          
          // Pequena pausa para não travar a interface
          await new Promise(resolve => setTimeout(resolve, 10));
        }

        esconderProgresso();

        let mensagem = `Processamento concluído! ${sucessos} equipamentos atualizados com sucesso.`;
        if (erros.length > 0) {
          mensagem += `\n\nErros encontrados:\n${erros.slice(0, 5).join('\n')}`;
          if (erros.length > 5) {
            mensagem += `\n... e mais ${erros.length - 5} erros.`;
          }
          mostrarMensagem(mensagem, 'aviso');
        } else {
          mostrarMensagem(mensagem, 'sucesso');
        }

        // Limpar textarea após sucesso
        if (sucessos > 0) {
          document.getElementById('csv-dados').value = '';
        }

      } catch (error) {
        esconderProgresso();
        mostrarMensagem(`Erro ao processar CSV: ${error.message}`, 'erro');
      } finally {
        btnAtualizar.disabled = false;
        btnAtualizar.textContent = 'Atualizar Status';
      }
    }

    function voltarParaEntrada() {
      window.location.href = 'entrada.html';
    }

    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>

